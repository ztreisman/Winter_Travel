---
title: "Winter Travel Data Project"
author: "Zack Treisman"
date: "1/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(car)
library(MASS)
library(gam)
library(pscl)
library(mgcv)
winter_travel <- read.csv("data/winter_travel.csv")
winter_travel$rating_near <- factor(winter_travel$rating_near)
all_users <- read.csv("data/all_users.csv")
all_users$rating_near <- factor(all_users$rating_near)
all_modes <- read.csv("data/all_modes.csv")
all_modes$rating_near <- factor(all_modes$rating_near)
all_locations <- read.csv("data/all_locations.csv")
all_locations$rating_near <- factor(all_locations$rating_near)
```

#  1. How do trail visitor counts correlate to an increase in snowfall during the previous day(s)? (what patterns of snowfall yield the most visitors/changes in visitation)

```{r}
ggplot(winter_travel, aes(change_depth, user.count, color = Trailhead))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.5)+
  facet_grid(modality~year)+
  scale_y_log10()

ggplot(winter_travel, aes(change_depth, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()+
  facet_grid(modality~Trailhead)

ggplot(winter_travel, aes(past3snow, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()+
  facet_grid(modality~Trailhead)

ggplot(winter_travel, aes(past5snow, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()+
  facet_grid(modality~Trailhead)

ggplot(all_users, aes(change_depth, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()

ggplot(all_users, aes(air_temp, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()

ggplot(all_users, aes(lag2snow, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()

ggplot(all_users, aes(lag3snow, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()

ggplot(all_users, aes(lag4snow, user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()

pairs(winter_travel[,c("change_depth","past2snow","past3snow","past4snow","past5snow")])
pairs(winter_travel[,c("change_depth","lag2snow","lag3snow","lag4snow")])
```

## Poisson models

```{r}
glm0 <- glm(user.count ~ 1, data=all_users)
summary(glm0)

glm1 <- glm(user.count ~ change_depth+lag2snow+lag3snow+lag4snow+air_temp, family = poisson, data=all_users)
summary(glm1)
hist(resid(glm1))
confint(glm1)
```
Don't like this model. AIC went way up adding predictors. Overdispersion is definitely present. Negative binomial is probably a better choice for the conditional distribution.

## Negative binomial models

```{r}
glm0nb <- glm.nb(user.count ~ weekend, data=all_users)
summary(glm0nb)

glm1nb <- glm.nb(user.count ~ change_depth+lag3snow+air_temp+weekend, data=all_users)
summary(glm1nb)
hist(resid(glm1nb))
confint(glm1nb)
```

Looking at AIC, adding predictors gives a slight improvement. Looks like about a 2.7% decrease in users per cm of new snow. Maybe about an 0.6% increase in users per degC of air temp. Recent snow doesn't register a strong effect.

#  2. How does an increased avalanche risk impact the numbers of hybrid and motorized visitors to specific trailheads?

```{r}
ggplot(na.omit(winter_travel), aes(rating_near, user.count, color = Trailhead, fill = Trailhead))+
  geom_point(position=position_jitterdodge(jitter.width = 0.2))+
  geom_boxplot(color="black", outlier.shape = NA)+
  scale_y_log10()+
  facet_wrap(~has_sled)

ggplot(na.omit(winter_travel), aes(rating_near, user.count))+
  geom_jitter()+
  geom_boxplot(outlier.shape = NA)+
  scale_y_log10()+
  facet_grid(has_sled~Trailhead)
```

We'll model the trailheads independently since they are so different. Lots of things to say, but one note is that at Kebler, only high ratings lead to statistically significant drops in use, but at Slate, there's a noticable drop at considerable and maybe even moderate.

```{r}
glm2brushrd <- glm.nb(user.count ~ rating_near, 
                  data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Brush Creek Rd"),])
summary(glm2brushrd)

glm2brushth <- glm.nb(user.count ~ rating_near, 
                   data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Brush Creek Trailhead"),])
summary(glm2brushth)

glm2gothic <- glm.nb(user.count ~ rating_near, 
                  data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Gothic Rd"),])
summary(glm2gothic)

glm2cement <- glm.nb(user.count ~ rating_near, 
                  data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Cement Creek"),])
summary(glm2cement)

glm2kebler <- glm.nb(user.count ~ rating_near, 
                  data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Kebler"),])
summary(glm2kebler)

glm2slate <- glm.nb(user.count ~ rating_near, 
                  data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Slate River Rd"),])
summary(glm2slate)

glm2snodgrass <- glm.nb(user.count ~ rating_near, 
                  data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Snodgrass"),])
summary(glm2snodgrass)

glm2washington <- glm.nb(user.count ~ rating_near, 
                  data=winter_travel[(winter_travel$has_sled==TRUE)&(winter_travel$Trailhead=="Washington Gulch"),])
summary(glm2washington)
```

#  3. What combination of weather conditions yields the highest/lowest number of visitors?

```{r}
ggplot(winter_travel, aes(air_temp, past5snow, size = user.count, color = rating_near))+
  geom_jitter(height = 0.2, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))

ggplot(winter_travel, aes(air_temp, change_depth, size = user.count, color = rating_near))+
  geom_jitter(height = 0.2, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))

ggplot(winter_travel, aes(air_temp, past5snow, size = user.count, color = rating_near))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  facet_grid(modality~Trailhead)

glm3 <- glm.nb(user.count~air_temp+change_depth+snow_depth, data=winter_travel)
summary(glm3)
```

This ended up being basically the same as question 1, since the past days' snow didn't show significance.

#  4. What sample size is needed to represent the entire season ?

This depends on the question, and the effect size that we care about.

#  5. Which days of the week have the highest number of visitors? Weekdays vs weekends?

```{r}
glm5 <- glm.nb(user.count~weekend, data=winter_travel)
summary(glm5)

glm5a <- glm.nb(user.count~week, data=winter_travel)
summary(glm5a)
```

Saturdays are about 13% busier than Sundays, weekdays are about half as busy as weekends.

#  6. How do visitation rates for different user groups vary seasonally?

```{r}
ggplot(winter_travel, aes(year, user.count))+
  geom_jitter(height = 0, width = 0.2, alpha = 0.7)+
  facet_grid(modality~Trailhead)+
  scale_y_log10()
```


#  7. Which days of the year are busiest?

```{r}
day_totals <- all_users %>% 
  group_by(date, week, weekend) %>%
  summarise(users = sum(user.count, na.rm = TRUE)) %>%
  arrange(desc(users))

head(day_totals, 10)

ggplot(day_totals, aes((yday(date)+30)%%365, users))+
  geom_smooth()+
  geom_point(aes(color=weekend))+
  scale_x_continuous(breaks = c(0,31,62,90,120), 
                     labels = c("Dec 1", "Jan 1", "Feb 1", "Mar 1", "Apr 1"))+
  labs(x="")
```

Jump in usage in the last week of the calendar year, otherwise gradual increase until sometime mid March.

#  8. Do different groups of users utilize the trail more during different times of the season?

```{r}
day_totals_modes <- all_locations %>% 
  group_by(date, week, weekend, modality, has_sled) %>%
  summarise(users = sum(user.count, na.rm = TRUE)) %>%
  arrange(desc(users))

head(day_totals_modes, 10)

ggplot(day_totals_modes, aes((yday(date)+30)%%365, users))+
  geom_smooth()+
  geom_point(aes(color=weekend))+
  scale_x_continuous(breaks = c(0,31,62,90,120), 
                     labels = c("Dec 1", "Jan 1", "Feb 1", "Mar 1", "Apr 1"))+
  scale_y_log10()+
  labs(x="")+
  facet_grid(modality~1)

day_totals_modes2 <- all_locations %>% 
  group_by(date, week, weekend, has_sled) %>%
  summarise(users = sum(user.count, na.rm = TRUE)) %>%
  arrange(desc(users))

ggplot(day_totals_modes2, aes((yday(date)+30)%%365, users))+
  geom_smooth()+
  geom_point(aes(color=weekend))+
  scale_x_continuous(breaks = c(0,31,62,90,120), 
                     labels = c("Dec 1", "Jan 1", "Feb 1", "Mar 1", "Apr 1"))+
  scale_y_log10()+
  labs(x="")+
  facet_grid(has_sled~1)
```

Variance is greater in the motorized groups, and the end of year and mid March peaks are more pronounced.

```{r}
gam6 <- gam(user.count ~ modality+s((yday(date)+30)%%365), family = nb(), data=all_locations)
summary(gam6)
```

#  9.  How did covid affect visitation rates and use patterns?

```{r}
march_on <- all_users[month(all_users$date)%in%3:4,]
ggplot(march_on, aes((yday(march_on$date)+30%%365), user.count, color=year))+
  geom_point()+geom_smooth()+
  scale_x_continuous(breaks = c(90,122), 
                     labels = c("Mar 1", "Apr 1"))+
  scale_y_log10()+
  labs(x="")+
  facet_grid(has_sled~1)
```

I don't see anything.

#  10. What are major year-to-year trends in visitation?

```{r}
ggplot(winter_travel, aes(year, user.count))+
  geom_boxplot()+
  geom_jitter(height = 0.2, width = 0.2, alpha = 0.2, aes( color = rating_near))+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()+
  facet_grid(modality~Trailhead)

ggplot(all_modes, aes(year, user.count))+
  geom_boxplot()+
  geom_jitter(height = 0.2, width = 0.2, alpha = 0.2, aes( color = rating_near))+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()+
  facet_grid(~Trailhead)

ggplot(all_locations, aes(year, user.count))+
  geom_boxplot()+
  geom_jitter(height = 0.2, width = 0.2, alpha = 0.2, aes( color = rating_near))+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()+
  facet_grid(~modality)

ggplot(all_users, aes(year, user.count))+
  geom_boxplot()+
  geom_jitter(height = 0.2, width = 0.2, alpha = 0.2, aes( color = rating_near))+
  scale_color_manual(values = c("green", "yellow", "orange", "red"))+
  scale_y_log10()+
  facet_grid(~has_sled)

glm10 <- glm.nb(user.count~year*(Trailhead+modality+rating_near), data = winter_travel)
summary(glm10)
```

#  11. How do the days with the highest avalanche risk affect visitor rates?

```{r}
high_risk <- as.numeric(winter_travel$rating_above)+
  as.numeric(winter_travel$rating_near)+
  as.numeric(winter_travel$rating_below) > 9
summary(glm.nb(user.count~high_risk, data=winter_travel))
```

On high risk days the usage is about 30% of the average on days that are not high risk.

